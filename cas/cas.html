<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CNC Kalkulátor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 10px;
            background: #f5f5f5;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1976d2;
            font-size: 1.5rem;
            margin: 0 0 15px 0;
            padding: 0;
        }

        h2 {
            color: #424242;
            font-size: 1.2rem;
            margin: 0 0 10px 0;
            padding: 0;
        }

        .input-group {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .start-end-group { background: #e3f2fd; }
        .center-group { background: #e8f5e9; }
        .conditions-group { background: #fff3e0; }
        .results-group { background: #f5f5f5; }

        label {
            display: block;
            color: #616161;
            font-size: 0.9rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px; /* Prevent iOS zoom on focus */
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }

        select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23424242'%3E%3Cpath d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }

        .result-item {
            margin-bottom: 15px;
        }

        .result-label {
            color: #616161;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .result-value {
            font-weight: 500;
            color: #2196f3;
            font-size: 1.1rem;
        }

        #error-message {
            color: #f44336;
            margin-bottom: 10px;
            font-weight: 500;
            padding: 10px;
            border-radius: 8px;
            background: #ffebee;
            display: none;
        }

        #error-message:not(:empty) {
            display: block;
        }

        #diagram {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 15px;
            background: white;
            touch-action: none;
            cursor: grab;
        }

        #diagram:active {
            cursor: grabbing;
        }

        .diagram-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .diagram-button {
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .diagram-button:hover {
            background: #1976d2;
        }

        #debug {
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
        }

        @media (min-width: 500px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Vylepšení pro dotykové ovládání */
        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Zabránění dvojitému klepnutí pro zoom na iOS */
        * {
            touch-action: manipulation;
        }

        /* Přidat nové styly pro rozdělení */
        .input-section {
            position: relative;
            padding: 10px;
        }

        .input-section:first-child::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 10px;
            bottom: 10px;
            width: 1px;
            background-color: #bbb;
        }

        .input-group h3 {
            color: #666;
            font-size: 0.9rem;
            margin: 0 0 10px 0;
            font-weight: 500;
        }

        .calc-button {
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            margin-bottom: 15px;
        }

        .calc-button:hover {
            background-color: #1976d2;
        }

        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ccc;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transform: translateY(calc(100% - 30px));
            transition: transform 0.3s;
            z-index: 1000;
        }

        .debug-panel.expanded {
            transform: translateY(0);
        }

        .debug-header {
            padding: 5px 15px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
        }

        .debug-header h3 {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        .debug-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .debug-toggle {
            color: #666;
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .debug-panel.expanded .debug-toggle {
            transform: rotate(180deg);
        }

        .header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .header-with-button h2 {
            margin: 0;
        }

        .calc-button {
            padding: 4px 12px;
            font-size: 0.85rem;
            margin: 0;  /* Odstranit margin-bottom */
        }

        .cnc-input-group {
            background: #f0f4f8;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .cnc-editor {
            width: 100%;
            height: 100px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            white-space: pre;
            overflow-x: auto;
        }

        .cnc-parse-button {
            background-color: #4caf50;
            margin-top: 10px;
            width: 100%;
        }

        .cnc-parse-button:hover {
            background-color: #45a049;
        }

        .speed-mode-toggle {
            margin-bottom: 15px;
        }

        .speed-mode-toggle label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .speed-mode-toggle input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }

        #g96conditions, #g97conditions {
            transition: opacity 0.3s;
        }

        /* Přidat nové styly pro tlačítko */
        .speed-mode-button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.3s;
        }

        .speed-mode-button:hover {
            background: #f0f0f0;
        }

        .speed-mode-button.g97 {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        /* Optimalizace pro mobilní zařízení */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
                margin: 0;
                max-width: 100%;
                border-radius: 0;
            }

            .input-group {
                padding: 10px;
                margin-bottom: 10px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            input, select {
                height: 44px; /* Větší výška pro lepší dotykové ovládání */
                font-size: 16px;
                margin-bottom: 10px;
            }

            .calc-button {
                height: 44px;
                padding: 0 15px;
                font-size: 16px;
            }

            .speed-mode-button {
                height: 44px;
                font-size: 16px;
            }

            /* Odstranit dělící čáru mezi sekcemi na mobilu */
            .input-section:first-child::after {
                display: none;
            }

            /* Přizpůsobit velikost SVG diagramu */
            #diagram {
                height: 250px;
            }

            /* Upravit debug panel */
            .debug-panel {
                transform: translateY(calc(100% - 40px));
            }

            .debug-header {
                height: 40px;
                padding: 0 15px;
            }

            .debug-toggle {
                font-size: 20px;
            }

            /* Zvětšit písmo pro lepší čitelnost */
            .result-label {
                font-size: 14px;
            }

            .result-value {
                font-size: 16px;
            }

            /* Přidat podporu pro safe-area-inset na iOS */
            .container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        /* Vylepšení dotykového ovládání */
        @media (hover: none) {
            input[type="number"] {
                -webkit-appearance: none;
                margin: 0;
            }

            .calc-button:active,
            .speed-mode-button:active {
                opacity: 0.7;
            }
        }

        /* Zabránění označení textu při dvojitém klepnutí */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* Povolit výběr textu pouze v textových polích */
        input, textarea {
            user-select: text;
        }

        /* Zrušit zákaz výběru textu a vrátit výchozí chování */
        * {
            user-select: auto;
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
        }

        /* Zakázat výběr textu pouze pro specifické elementy */
        .speed-mode-button,
        .calc-button,
        .debug-header,
        .result-label,
        svg text,
        .line-numbers {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Explicitně povolit výběr textu pro důležitá pole */
        textarea,
        input,
        .result-value,
        #debug {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            cursor: text;
        }

        .speed-mode-button {
            width: 100%;
            height: 44px; /* Stejná výška jako input */
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.3s;
        }

        .conditions-group .grid {
            gap: 15px; /* Mezera mezi sloupci */
        }

        .conditions-group label {
            margin-bottom: 8px;
        }

        .diamoff-toggle {
            margin: 15px 0;
        }

        .diamoff-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .diamoff-toggle input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .diam-mode-button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.3s;
            height: 44px;
            white-space: nowrap;
        }

        .diam-mode-button:hover {
            background: #f0f0f0;
        }

        .diam-mode-button.diamoff {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .calculated-value {
            font-weight: 500;
            color: #2196f3;
            font-size: 1.1rem;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            margin-top: 4px;
        }

        .diagram-container {
            position: relative;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 15px;
            background: white;
        }

        #diagram {
            width: 100%;
            height: 300px;
            touch-action: none;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .zoom-button {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .zoom-button:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CNC Kalkulátor</h1>
        <div id="error-message"></div>

        <!-- 1. Vstupní metoda -->
        <div class="input-group method-group">
            <div class="header-with-button">
                <h2>Způsob zadání</h2>
            </div>
            <div class="input-section">
                <select id="inputMethod" class="full-width">
                    <option value="manual">Ruční zadání bodů</option>
                    <option value="cnc">Načíst z CNC kódu</option>
                </select>
            </div>
        </div>

        <!-- 2. CNC kód (původně cnc-input-group) -->
        <div id="cncInputSection" class="input-group cnc-input-group" style="display: none;">
            <div class="header-with-button">
                <h2>CNC Kód</h2>
                <button id="parseCodeButton" class="calc-button cnc-parse-button">Načíst hodnoty</button>
            </div>
            <textarea id="cncCode" class="cnc-editor" placeholder="Vložte CNC kód (např.: N10 G1 X100 Z25 F0.2&#10;N20 G2 X50 Z50 CR=25 F0.15)"></textarea>
        </div>

        <!-- 3. Manuální zadání bodů (původně start-end-group) -->
        <div id="manualInputSection" class="input-group start-end-group">
            <div class="header-with-button">
                <h2>Počáteční a koncový bod (X jako poloměr)</h2>
            </div>
            <div>
                <div id="prevPointSection" class="input-section" style="display: none;">
                    <h3>Počáteční bod (před radiusem):</h3>
                    <div class="grid">
                        <div>
                            <label>X [mm] (poloměr)</label>
                            <input type="number" id="prevX" value="30" step="any" inputmode="decimal">
                        </div>
                        <div>
                            <label>Z [mm]</label>
                            <input type="number" id="prevZ" value="10" step="any" inputmode="decimal">
                        </div>
                    </div>
                </div>
                <div class="input-section">
                    <h3>Začátek radiusu:</h3>
                    <div class="grid">
                        <div>
                            <label>X [mm] (poloměr)</label>
                            <input type="number" id="startX" value="30" step="any" inputmode="decimal">
                        </div>
                        <div>
                            <label>Z [mm]</label>
                            <input type="number" id="startZ" value="30" step="any" inputmode="decimal">
                        </div>
                    </div>
                </div>
                <div class="input-section">
                    <h3>Konec radiusu:</h3>
                    <div class="grid">
                        <div>
                            <label>X [mm] (poloměr)</label>
                            <input type="number" id="endX" value="20" step="any" inputmode="decimal">
                        </div>
                        <div>
                            <label>Z [mm]</label>
                            <input type="number" id="endZ" value="150" step="any" inputmode="decimal">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Výpočet geometrie (původně center-group) -->
        <div class="input-group center-group">
            <div class="header-with-button">
                <h2>Střed a radius</h2>
                <div class="button-group">
                    <button id="calcCenterButton" class="calc-button">Vypočítat (CR)</button>
                    <button id="ctButton" class="calc-button">CT</button>
                    <button id="ikButton" class="calc-button">IK</button>
                    <button id="arButton" class="calc-button">AR</button>
                    <button id="cipButton" class="calc-button">CIP</button>
                </div>
            </div>
            <div class="grid">
                <div class="input-section">
                    <h3>Střed</h3>
                    <div id="calculatedRadius" style="display: none; margin-bottom: 10px;">
                        <label>Vypočtený radius [mm]:</label>
                        <div class="calculated-value">0.000</div>
                    </div>
                    <label>X (I) [mm] (poloměr)</label>
                    <input type="number" id="centerX" value="50" step="any" inputmode="decimal">
                    <label>Z (K) [mm]</label>
                    <input type="number" id="centerZ" value="50" step="any" inputmode="decimal">
                </div>
                <div class="input-section">
                    <h3>Radius a směr</h3>
                    <label>Typ zadání</label>
                    <select id="radiusType">
                        <option value="CR">CR= (Radius)</option>
                        <option value="AR">AR= (Úhel)</option>
                        <option value="IK">I K (Střed inkrementálně)</option>
                        <option value="CT">CT= (Tečné napojení)</option>
                        <option value="CIP">CIP= (Průchozí bod)</option>
                    </select>

                    <div id="radiusInputCR">
                        <label>Radius [mm]</label>
                        <input type="number" id="radius" value="25" step="any" inputmode="decimal">
                    </div>

                    <div id="radiusInputAR" style="display: none;">
                        <label>Úhel [°]</label>
                        <input type="number" id="arcAngle" value="90" step="any" inputmode="decimal">
                    </div>

                    <div id="radiusInputIK" style="display: none;">
                        <label>I - přírůstek v X [mm]</label>
                        <input type="number" id="centerDX" step="any" inputmode="decimal">
                        <label>K - přírůstek v Z [mm]</label>
                        <input type="number" id="centerDZ" step="any" inputmode="decimal">
                    </div>

                    <div id="radiusInputCT" style="display: none;">
                        <!-- Odstraníme původní sekci pro předchozí pohyb, protože je nyní v hlavní sekci -->
                    </div>

                    <label>Směr</label>
                    <select id="direction">
                        <option value="G2">G2 (ve směru hod. ručiček)</option>
                        <option value="G3">G3 (proti směru hod. ručiček)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 5. Geometrické výsledky (nová sekce) -->
        <div class="input-group geometry-results-group">
            <h2>Geometrické výsledky</h2>
            <div class="grid">
                <div class="result-item">
                    <div class="result-label">Střed oblouku:</div>
                    <div class="result-value" id="arcCenter">I: 0.000, K: 0.000</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Délka oblouku:</div>
                    <div class="result-value" id="arcLength">0.00 mm</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Úhly:</div>
                    <div class="result-value" id="angles">Start: 0.0°, Konec: 0.0°</div>
                </div>
            </div>
        </div>

        <!-- 6. Řezné podmínky (původně conditions-group) -->
        <div class="input-group conditions-group">
            <h2>Řezné podmínky</h2>
            <div class="grid">
                <div>
                    <label>Režim:</label>
                    <button id="speedModeButton" class="speed-mode-button">G96 (konstantní řezná rychlost)</button>
                </div>
                <div>
                    <label>Posuv [mm/ot]</label>
                    <input type="number" id="feed" value="0.8" step="any" inputmode="decimal">
                </div>
            </div>
            <!-- Podmínky pro G96 -->
            <div id="g96conditions">
                <div class="grid">
                    <div>
                        <label>Řezná rychlost [m/min]</label>
                        <input type="number" id="cuttingSpeed" value="170" step="any" inputmode="decimal">
                    </div>
                    <div>
                        <label>LIMS - Max. otáčky [ot/min]</label>
                        <input type="number" id="speedLimit" value="190" step="any" inputmode="decimal">
                    </div>
                </div>
            </div>
            <!-- Podmínky pro G97 -->
            <div id="g97conditions" style="display: none;">
                <div class="grid">
                    <div>
                        <label>Otáčky [ot/min]</label>
                        <input type="number" id="constantSpeed" value="1000" step="any" inputmode="decimal">
                    </div>
                    <div></div><!-- Prázdný div pro zarovnání -->
                </div>
            </div>
        </div>

        <!-- 7. Technologické výsledky (upravená results-group) -->
        <div class="input-group results-group">
            <h2>Technologické výsledky</h2>
            <div class="grid">
                <div>
                    <div class="result-item">
                        <div class="result-label">Efektivní průměr:</div>
                        <div class="result-value" id="effectiveDiameter">0.00 mm</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Průměrné otáčky:</div>
                        <div class="result-value" id="rpm">0 ot/min</div>
                    </div>
                </div>
                <div>
                    <div class="result-item">
                        <div class="result-label">Čas obrábění:</div>
                        <div class="result-value" id="machiningTime">0.00 s</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 8. Vizualizace (původní diagram-container) -->
        <div class="diagram-container">
            <svg id="diagram" viewBox="-100 -100 200 200"></svg>
            <div class="zoom-controls">
                <button class="zoom-button" id="zoomIn">+</button>
                <button class="zoom-button" id="zoomOut">-</button>
                <button class="zoom-button" id="zoomReset">↺</button>
            </div>
        </div>

        <!-- 9. Debug panel -->
        <div class="debug-panel" id="debugPanel">
            <div class="debug-header" id="debugHeader">
                <h3>Debug výstup</h3>
                <span class="debug-toggle">▼</span>
            </div>
            <div class="debug-content">
                <div id="debug"></div>
            </div>
        </div>
    </div>

    <!-- JavaScript zůstává stejný -->
    <script>
        import { GeometryCalculator } from '../modules/geometry.js';
        import { MachiningCalculator } from '../modules/machining.js';
        import { CNCParser } from '../modules/cncParser.js';
        import { ArcDiagram } from '../components/ArcDiagram.js';

        // Pomocná funkce pro debugování
        function debug(msg) {
            const debugEl = document.getElementById('debug');
            if (debugEl) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                debugEl.textContent += `[${timestamp}] ${msg}\n`;

                // Scrollovat na konec pouze pokud je panel otevřený
                const debugPanel = document.getElementById('debugPanel');
                if (debugPanel.classList.contains('expanded')) {
                    debugEl.scrollTop = debugEl.scrollHeight;
                }
            }
            console.log(msg);
        }

        function getDiameterRadius(diameter) {
            return diameter / 2;
        }

        function calculateAngle(z, x, centerZ, centerX) {
            const deltaZ = z - centerZ;
            const deltaX = x - centerX;
            const angle = Math.atan2(deltaX, deltaZ);

            debug(`Výpočet úhlu: deltaZ=${deltaZ.toFixed(3)}, deltaX=${deltaX.toFixed(3)}, úhel=${(angle * 180 / Math.PI).toFixed(2)}°`);
            return angle;
        }

        // Upravit calculateIJK pro správný výpočet relativních hodnot
        function calculateIJK(startZ, startX, centerZ, centerX) {
            // Změna na relativní hodnoty - opačný výpočet než předtím
            const i = -(centerX - startX);  // Změna znaménka pro správný směr
            const k = -(centerZ - startZ);  // Změna znaménka pro správný směr

            debug(`IJK parametry (relativní k počátku):`);
            debug(`I(X) = ${i.toFixed(3)} (-(${centerX} - ${startX}))`);
            debug(`K(Z) = ${k.toFixed(3)} (-(${centerZ} - ${startZ}))`);

            return { i, k };
        }

        function formatTime(time) {
            if (time < 60) {
                return `${time.toFixed(1)} s`;
            } else if (time < 3600) {
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                return `${minutes}:${seconds.toFixed(0).padStart(2, '0')} min`;
            } else {
                const hours = Math.floor(time / 3600);
                const minutes = Math.floor((time % 3600) / 60);
                const seconds = time % 60;
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toFixed(0).padStart(2, '0')} h`;
            }
        }

        function calculateAll() {
            debug('\n--- Začátek nového výpočtu ---');
            try {
                const isG96 = !document.getElementById('speedModeButton').classList.contains('g97');
                const params = {
                    startZ: parseFloat(document.getElementById('startZ').value),
                    startX: parseFloat(document.getElementById('startX').value), // Už je poloměr
                    endZ: parseFloat(document.getElementById('endZ').value),
                    endX: parseFloat(document.getElementById('endX').value), // Už je poloměr
                    centerZ: parseFloat(document.getElementById('centerZ').value),
                    centerX: parseFloat(document.getElementById('centerX').value), // Už je poloměr
                    radius: parseFloat(document.getElementById('radius').value),
                    cuttingSpeed: parseFloat(document.getElementById('cuttingSpeed').value),
                    feed: parseFloat(document.getElementById('feed').value),
                    direction: document.getElementById('direction').value
                };

                debug('Načtené parametry:');
                debug(JSON.stringify(params, null, 2));

                const numericParams = Object.entries(params).filter(([key]) => key !== 'direction');
                if (numericParams.some(([_, value]) => isNaN(value))) {
                    document.getElementById('error-message').textContent =
                        'Chyba: Všechny hodnoty musí být čísla!';
                    debug('Chyba: Neplatné vstupní hodnoty');
                    return;
                }

                if (!validateInputs(params)) {
                    document.getElementById('error-message').textContent =
                        'Chyba: Neplatné vstupní hodnoty (záporné nebo nulové hodnoty)';
                    return;
                }

                if (!validateArc(params)) {
                    document.getElementById('error-message').textContent =
                        'Chyba: Body neleží na kružnici s daným radiusem!';
                    return;
                }

                document.getElementById('error-message').textContent = '';

                const startAngle = calculateAngle(params.startZ, params.startX, params.centerZ, params.centerX);
                const endAngle = calculateAngle(params.endZ, params.endX, params.centerZ, params.centerX);

                let angleDiff = endAngle - startAngle;
                if (params.direction === 'G2') {
                    while (angleDiff > 0) angleDiff -= 2 * Math.PI;
                    while (angleDiff <= -2 * Math.PI) angleDiff += 2 * Math.PI;
                } else {
                    while (angleDiff < 0) angleDiff += 2 * Math.PI;
                    while (angleDiff >= 2 * Math.PI) angleDiff -= 2 * Math.PI;
                }

                debug(`Úhlový rozdíl: ${(angleDiff * 180 / Math.PI).toFixed(2)}°`);

                const segments = 100;
                let totalLength = 0;
                let totalTime = 0;

                const maxDiameter = Math.max(params.startX, params.endX) * 2;  // Dvojnásobek poloměru
                const minDiameter = Math.min(params.startX, params.endX) * 2;  // Dvojnásobek poloměru

                for (let i = 0; i < segments; i++) {
                    const angle = startAngle + (angleDiff * i) / segments;
                    const currentRadius = params.centerX + params.radius * Math.sin(angle);
                    const currentDiameter = currentRadius * 2;

                    const arcLength = Math.abs(params.radius * angleDiff) / segments;
                    totalLength += arcLength;

                    if (isG96) {
                        const speedLimit = parseFloat(document.getElementById('speedLimit').value);
                        const theoreticalRPM = (params.cuttingSpeed * 1000) / (Math.PI * currentDiameter);
                        const actualRPM = Math.min(theoreticalRPM, speedLimit);

                        const segmentTime = arcLength / (actualRPM * params.feed);
                        totalTime += segmentTime;
                    } else {
                        const constantSpeed = parseFloat(document.getElementById('constantSpeed').value);
                        const segmentTime = arcLength / (constantSpeed * params.feed);
                        totalTime += segmentTime;
                    }
                }

                const effectiveDiameter = (params.cuttingSpeed * 1000 * totalTime * params.feed) / (Math.PI * totalLength);
                let rpmMin, rpmMax, rpmAvg;

                if (isG96) {
                    const speedLimit = parseFloat(document.getElementById('speedLimit').value);
                    rpmMax = Math.min(
                        (params.cuttingSpeed * 1000) / (Math.PI * minDiameter),
                        speedLimit
                    );
                    rpmMin = Math.min(
                        (params.cuttingSpeed * 1000) / (Math.PI * maxDiameter),
                        speedLimit
                    );
                    rpmAvg = Math.min(
                        (params.cuttingSpeed * 1000) / (Math.PI * effectiveDiameter),
                        speedLimit
                    );
                } else {
                    const constantSpeed = parseFloat(document.getElementById('constantSpeed').value);
                    rpmMin = rpmMax = rpmAvg = constantSpeed;
                }

                document.getElementById('effectiveDiameter').textContent =
                    `${effectiveDiameter.toFixed(2)} mm`;

                const theoreticalRpmAvg = Math.round((params.cuttingSpeed * 1000) / (Math.PI * effectiveDiameter));
                const theoreticalRpmMin = Math.round((params.cuttingSpeed * 1000) / (Math.PI * maxDiameter));
                const theoreticalRpmMax = Math.round((params.cuttingSpeed * 1000) / (Math.PI * minDiameter));

                document.getElementById('rpm').innerHTML =
                    `${Math.round(rpmAvg)} ot/min (${theoreticalRpmAvg})
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        ${isG96 ?
                            `Otáčky na Ø${maxDiameter.toFixed(1)}mm: ${Math.round(rpmMin)} ot/min (${theoreticalRpmMin})<br>
                            Otáčky na Ø${minDiameter.toFixed(1)}mm: ${Math.round(rpmMax)} ot/min (${theoreticalRpmMax})` :
                            'Konstantní otáčky (G97)'}
                    </div>`;

                document.getElementById('arcLength').textContent = `${totalLength.toFixed(2)} mm`;
                document.getElementById('machiningTime').textContent = formatTime(totalTime * 60);

                const ijkParams = calculateIJK(params.startZ, params.startX, params.centerZ, params.centerX);
                document.getElementById('arcCenter').textContent =
                    `I: ${ijkParams.i.toFixed(3)}, K: ${ijkParams.k.toFixed(3)}`;

                // Aktualizace úhlů v geometrických výsledcích
                document.getElementById('angles').textContent =
                    `Start: ${(startAngle * 180 / Math.PI).toFixed(1)}°, Konec: ${(endAngle * 180 / Math.PI).toFixed(1)}°`;

                // Použít existující element s ID 'ijkParams'
                const ijkElement = document.getElementById('ijkParams');
                if (ijkElement) {
                    ijkElement.textContent = `I: ${ijkParams.i.toFixed(3)}, K: ${ijkParams.k.toFixed(3)}`;
                } else {
                    debug('Chyba: Nenalezen element pro IJK parametry');
                }

                // Stejná kontrola pro ostatní elementy
                const anglesElement = document.getElementById('angles');
                if (anglesElement) {
                    anglesElement.textContent = `Start: ${(startAngle * 180 / Math.PI).toFixed(1)}°, Konec: ${(endAngle * 180 / Math.PI).toFixed(1)}°`;
                }

                const arcLengthElement = document.getElementById('arcLength');
                if (arcLengthElement) {
                    arcLengthElement.textContent = `${totalLength.toFixed(2)} mm`;
                }

                updateDiagram(params, startAngle, angleDiff);

                // Před koncem funkce přidáme kontrolu výpočtu
                debug(`Geometrické výsledky:`);
                debug(`I: ${ijkParams.i.toFixed(3)}, K: ${ijkParams.k.toFixed(3)}`);
                debug(`Úhly: Start=${(startAngle * 180 / Math.PI).toFixed(1)}°, Konec=${(endAngle * 180 / Math.PI).toFixed(1)}°`);
                debug(`Délka oblouku: ${totalLength.toFixed(2)} mm`);

            } catch (error) {
                debug(`Chyba při výpočtu: ${error.message}`);
                document.getElementById('error-message').textContent = `Chyba při výpočtu: ${error.message}`;
            }
        }

        function updateDiagram(params, startAngle, angleDiff) {
            debug('\nAktualizace diagramu');
            const svg = document.getElementById('diagram');
            svg.innerHTML = '';

            const isCTMode = document.getElementById('radiusType').value === 'CT';
            const prevX = isCTMode ? parseFloat(document.getElementById('prevX').value) : null;
            const prevZ = isCTMode ? parseFloat(document.getElementById('prevZ').value) : null;

            // Body dráhy (bez středu)
            const pathPoints = [
                ...(isCTMode ? [{ z: prevZ, x: -prevX, label: 'P0' }] : []),
                { z: params.startZ, x: -params.startX, label: 'S' },
                { z: params.endZ, x: -params.endX, label: 'E' }
            ];

            // Výpočet rozsahu pohledu pouze pro dráhu
            let minZ = Math.min(...pathPoints.map(p => p.z));
            let maxZ = Math.max(...pathPoints.map(p => p.z));
            let minX = Math.min(...pathPoints.map(p => p.x));
            let maxX = Math.max(...pathPoints.map(p => p.x));

            // Přidat trochu prostoru kolem dráhy
            const paddingZ = (maxZ - minZ) * 0.2;
            const paddingX = (maxX - minX) * 0.2;
            const viewBoxWidth = maxZ - minZ + 2 * paddingZ;
            const viewBoxHeight = maxX - minX + 2 * paddingX;

            // Nastavit viewBox pro maximální využití prostoru kolem dráhy
            const svgRect = svg.getBoundingClientRect();
            const aspectRatio = svgRect.width / svgRect.height;
            const viewBoxAspectRatio = viewBoxWidth / viewBoxHeight;

            let finalViewBox;
            if (viewBoxAspectRatio > aspectRatio) {
                const newHeight = viewBoxWidth / aspectRatio;
                const extraPadding = (newHeight - viewBoxHeight) / 2;
                finalViewBox = `${minZ - paddingZ} ${minX - paddingX - extraPadding} ${viewBoxWidth} ${newHeight}`;
            } else {
                const newWidth = viewBoxHeight * aspectRatio;
                const extraPadding = (newWidth - viewBoxWidth) / 2;
                finalViewBox = `${minZ - paddingZ - extraPadding} ${minX - paddingX} ${newWidth} ${viewBoxHeight}`;
            }
            svg.setAttribute('viewBox', finalViewBox);

            // Přidat středový bod do seznamu bodů pro vykreslení (ale ne pro výpočet viewBoxu)
            const allPoints = [
                ...pathPoints,
                { z: params.centerZ, x: -params.centerX, label: 'C' }
            ];

            // Vykreslení předchozího pohybu pro CT
            if (isCTMode) {
                const prevLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
                prevLine.setAttribute("d", `M ${prevZ} ${-prevX} L ${params.startZ} ${-params.startX}`);
                prevLine.setAttribute("stroke", "#666");
                prevLine.setAttribute("stroke-width", viewBoxWidth/150);
                prevLine.setAttribute("stroke-dasharray", "5,5");
                svg.appendChild(prevLine);
            }

            // Vykreslení oblouku
            const segments = 50;
            const startPoint = {
                z: params.startZ,
                x: -params.startX
            };
            let pathData = `M ${startPoint.z} ${startPoint.x}`;
            for (let i = 1; i <= segments; i++) {
                const angle = startAngle + (angleDiff * i) / segments;
                const z = params.centerZ + params.radius * Math.cos(angle);
                const x = params.centerX + params.radius * Math.sin(angle);
                pathData += ` L ${z} ${-x}`;
            }
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathData);
            path.setAttribute("stroke", "#2196f3");
            path.setAttribute("fill", "none");
            path.setAttribute("stroke-width", viewBoxWidth/100);
            svg.appendChild(path);

            // Vykreslení pomocných čar ke středu (tenčí a průhledné)
            const centerLines = document.createElementNS("http://www.w3.org/2000/svg", "g");
            centerLines.setAttribute("stroke", "rgba(255,0,0,0.3)");
            centerLines.setAttribute("stroke-width", viewBoxWidth/200);
            centerLines.setAttribute("stroke-dasharray", "5,5");
            centerLines.innerHTML = `
                <line x1="${params.centerZ}" y1="${-params.centerX}" x2="${params.startZ}" y2="${-params.startX}" />
                <line x1="${params.centerZ}" y1="${-params.centerX}" x2="${params.endZ}" y2="${-params.endX}" />
            `;
            svg.appendChild(centerLines);

            // Určit, na kterou stranu umístit popisek středu
            const centerAlignLeft = params.centerZ < (minZ + (maxZ - minZ) / 2);

            // Vykreslení bodů s jejich souřadnicemi - speciální zacházení pro střed
            allPoints.forEach(point => {
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", point.z);
                circle.setAttribute("cy", point.x);
                circle.setAttribute("r", viewBoxWidth/150);
                circle.setAttribute("fill", point.label === 'P0' ? "#666" : point.label === 'C' ? "#f44336" : "#2196f3");
                svg.appendChild(circle);

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                const isCenter = point.label === 'C';

                if (isCenter) {
                    const textOffset = centerAlignLeft ? -viewBoxWidth/20 : viewBoxWidth/40;
                    const anchor = centerAlignLeft ? "end" : "start";
                    text.setAttribute("x", point.z + textOffset);
                    text.setAttribute("y", point.x - viewBoxHeight/40);
                    text.setAttribute("text-anchor", anchor);
                } else {
                    text.setAttribute("x", point.z + viewBoxWidth/40);
                    text.setAttribute("y", point.x - viewBoxHeight/40);
                }
                text.setAttribute("font-size", viewBoxWidth/35);
                text.setAttribute("fill", "#333");

                if (isCenter) {
                    const ik = calculateIJK(params.startZ, params.startX, params.centerZ, params.centerX);
                    text.innerHTML = `${point.label}
                        <tspan x="${point.z + (centerAlignLeft ? -viewBoxWidth/20 : viewBoxWidth/40)}"
                               dy="1.2em"
                               font-size="${viewBoxWidth/45}"
                               fill="#666">
                            (${(-point.x).toFixed(1)}, ${point.z.toFixed(1)})
                        </tspan>
                        <tspan x="${point.z + (centerAlignLeft ? -viewBoxWidth/20 : viewBoxWidth/40)}"
                               dy="1.2em"
                               font-size="${viewBoxWidth/45}"
                               fill="#666">
                            I:${ik.i.toFixed(1)}, K:${ik.k.toFixed(1)}
                        </tspan>`;
                } else {
                    text.innerHTML = `${point.label}
                        <tspan x="${point.z + viewBoxWidth/40}"
                               dy="1.2em"
                               font-size="${viewBoxWidth/45}"
                               fill="#666">
                            (${(-point.x).toFixed(1)}, ${point.z.toFixed(1)})
                        </tspan>`;
                }
                svg.appendChild(text);
            });

            debug('Diagram aktualizován');
            svg.dataset.originalViewBox = finalViewBox;
        }

        // Upravit funkci calculateCenter, aby používala správný radius
        function calculateCenter(forceRecalc = false) {
            const radiusType = document.getElementById('radiusType').value;
            const startX = parseFloat(document.getElementById('startX').value);
            const startZ = parseFloat(document.getElementById('startZ').value);
            const endX = parseFloat(document.getElementById('endX').value);
            const endZ = parseFloat(document.getElementById('endZ').value);
            const direction = document.getElementById('direction').value;

            try {
                let center;
                let radius = parseFloat(document.getElementById('radius').value);

                switch(radiusType) {
                    case 'CR':
                        // Použít aktuální radius z pole
                        center = GeometryCalculator.calculateCenterFromRadius(startX, startZ, endX, endZ, radius, direction);
                        break;
                    case 'AR':
                        const angle = parseFloat(document.getElementById('arcAngle').value);
                        center = GeometryCalculator.calculateCenterFromAngle(startX, startZ, endX, endZ, angle, direction);
                        break;
                    case 'IK':
                        const i = parseFloat(document.getElementById('centerDX').value);
                        const k = parseFloat(document.getElementById('centerDZ').value);
                        center = {
                            x: startX + i,
                            z: startZ + k
                        };
                        // Aktualizovat radius při výpočtu
                        const ikRadius = Math.sqrt(i*i + k*k); // Přejmenováno na ikRadius
                        document.getElementById('radius').value = ikRadius.toFixed(3);
                        document.getElementById('calculatedRadius').querySelector('.calculated-value').textContent = ikRadius.toFixed(3);
                        break;
                    case 'CT':
                        const prevX = parseFloat(document.getElementById('prevX').value);
                        const prevZ = parseFloat(document.getElementById('prevZ').value);
                        center = GeometryCalculator.calculateCenterFromTangent(
                            prevX, prevZ,
                            startX, startZ,
                            endX, endZ
                        );
                        break;
                }

                if (center) {
                    document.getElementById('centerX').value = center.x.toFixed(3);
                    document.getElementById('centerZ').value = center.z.toFixed(3);
                    // Zachovat původní radius pro CR mód
                    calculateAll();
                }

                if (radiusType === 'CT' && center) {
                    const ctRadius = Math.hypot(center.z - startZ, center.x - startX); // Přejmenováno na ctRadius
                    document.getElementById('calculatedRadius').querySelector('.calculated-value').textContent = ctRadius.toFixed(3);
                    document.getElementById('radius').value = ctRadius.toFixed(3);
                }
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
                debug(`Chyba: ${error.message}`);
            }
        }

        document.getElementById('calcCenterButton').addEventListener('click', () => {
            calculateCenter(true);
        });

        document.querySelectorAll('input, select').forEach(input => {
            if (['centerX', 'centerZ', 'radius'].includes(input.id)) {
                input.addEventListener('input', () => {
                    calculateAll();
                });
            } else {
                input.addEventListener('input', calculateAll);
            }
        });

        document.getElementById('direction').addEventListener('change', calculateAll);

        document.getElementById('calcCenterButton').addEventListener('click', () => {
            calculateCenter();
        });

        calculateAll();

        const debugPanel = document.getElementById('debugPanel');
        const debugHeader = document.getElementById('debugHeader');

        debugHeader.addEventListener('click', () => {
            debugPanel.classList.toggle('expanded');
        });

        function calculateAngleBetween(start, end, center) {
            const startAngle = Math.atan2(
                -(start.x - center.x),
                start.z - center.z
            );
            const endAngle = Math.atan2(
                -(end.x - center.x),
                end.z - center.z
            );

            let angle = endAngle - startAngle;
            if (angle > Math.PI) angle -= 2 * Math.PI;
            if (angle < -Math.PI) angle += 2 * Math.PI;

            debug(`\nÚhly v kartézských souřadnicích:`);
            debug(`Start: ${(startAngle * 180 / Math.PI).toFixed(2)}°`);
            debug(`End: ${(endAngle * 180 / Math.PI).toFixed(2)}°`);
            debug(`Rozdíl: ${(angle * 180 / Math.PI).toFixed(2)}°`);

            return angle;
        }

        function roundToThree(num) {
            return parseFloat(parseFloat(num).toFixed(3));
        }

        function parseBlock(line) {
            return {
                isRapid: line.includes('G0'),
                x: line.match(/X([-\d.]+)/)?.[1],
                z: line.match(/Z([-\d.]+)/)?.[1],
                i: line.match(/I([-\d.]+)/)?.[1],
                k: line.match(/K([-\d.]+)/)?.[1],
                feed: line.match(/F([\d.]+)/)?.[1],
                cr: line.match(/CR=([-\d.]+)/)?.[1],
                ar: line.match(/AR=([-\d.]+)/)?.[1],
                ct: line.includes('CT'),
                cip: line.match(/CIP=\(([-\d.]+),([-\d.]+)\)/),  // Zachytí CIP=(X,Z)
                g2: line.includes('G2'),
                g3: line.includes('G3')
            };
        }

        function parseCncCode() {
            const codeText = document.getElementById('cncCode').value;
            debug('Parsování CNC kódu:');
            debug(codeText);

            const lines = codeText.trim().split('\n');
            let values = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith(';')) continue;

                const block = parseBlock(line);

                // Detekce G2/G3
                if (block.g2 || block.g3) {
                    if (!block.x || !block.z) {
                        debug('Chybí souřadnice v G2/G3 bloku');
                        continue;
                    }

                    // Získat předchozí pozici z předchozího bloku
                    let startX = null;
                    let startZ = null;
                    let prevX = null;
                    let prevZ = null;

                    // Hledáme až dva bloky zpět pro CT mód
                    for (let j = i - 2; j < i; j++) {
                        if (j >= 0) {
                            const prevBlock = parseBlock(lines[j].trim());
                            if (prevBlock.x && prevBlock.z) {
                                if (startX === null) {
                                    startX = parseFloat(prevBlock.x);
                                    startZ = parseFloat(prevBlock.z);
                                } else {
                                    prevX = parseFloat(prevBlock.x);
                                    prevZ = parseFloat(prevBlock.z);
                                }
                            }
                        }
                    }

                    if (startX === null || startZ === null) {
                        debug('Nelze najít počáteční bod');
                        continue;
                    }

                    const endX = parseFloat(block.x);
                    const endZ = parseFloat(block.z);

                    values = {
                        startX: roundToThree(startX),
                        startZ: roundToThree(startZ),
                        endX: roundToThree(endX),
                        endZ: roundToThree(endZ),
                        direction: block.g3 ? 'G3' : 'G2'
                    };

                    // Detekce typu zadání v pořadí priority
                    if (block.i !== null || block.k !== null) {
                        values = {
                            ...values,
                            type: 'IK',
                            centerDX: roundToThree(block.i ? parseFloat(block.i) : 0),
                            centerDZ: roundToThree(block.k ? parseFloat(block.k) : 0)
                        };
                    }
                    else if (block.cr !== null) {
                        values = {
                            ...values,
                            type: 'CR',
                            radius: roundToThree(parseFloat(block.cr))
                        };
                    }
                    else if (block.ct) {
                        values = {
                            ...values,
                            type: 'CT',
                            prevX: roundToThree(prevX),
                            prevZ: roundToThree(prevZ)
                        };
                    }
                    else if (block.ar !== null) {
                        values = {
                            ...values,
                            type: 'AR',
                            angle: roundToThree(parseFloat(block.ar))
                        };
                    }
                    else if (block.cip) {
                        values = {
                            ...values,
                            type: 'CIP',
                            throughX: roundToThree(parseFloat(block.cip[1])),
                            throughZ: roundToThree(parseFloat(block.cip[2]))
                        };
                    }

                    debug('Nalezeny hodnoty:');
                    debug(JSON.stringify(values, null, 2));
                    break;
                }
            }

            if (values) {
                updateValues(values);
            } else {
                debug('Nenalezen platný G2/G3 blok');
            }
        }

        // Upravená funkce updateValues pro podporu všech typů
        function updateValues(values) {
            debug('Aktualizuji hodnoty:');
            debug(JSON.stringify(values, null, 2));

            document.getElementById('radiusType').value = values.type;
            document.getElementById('direction').value = values.direction;

            // Základní souřadnice
            document.getElementById('startX').value = values.startX;
            document.getElementById('startZ').value = values.startZ;
            document.getElementById('endX').value = values.endX;
            document.getElementById('endZ').value = values.endZ;

            // Specifické hodnoty podle typu
            switch (values.type) {
                case 'CR':
                    document.getElementById('radius').value = values.radius;
                    break;
                case 'IK':
                    document.getElementById('centerDX').value = values.centerDX;
                    document.getElementById('centerDZ').value = values.centerDZ;
                    break;
                case 'CT':
                    document.getElementById('prevX').value = values.prevX;
                    document.getElementById('prevZ').value = values.prevZ;
                    break;
                case 'AR':
                    document.getElementById('arcAngle').value = values.angle;
                    break;
                case 'CIP':
                    // TODO: Přidat podporu pro CIP
                    break;
            }

            // Uložit hodnoty do localStorage
            localStorage.setItem('lastParsedValues', JSON.stringify(values));
            localStorage.setItem('lastInputMethod', values.type);

            // Vynutit přepočet
            document.getElementById('radiusType').dispatchEvent(new Event('change'));
            calculateCenter(true);
        }

        // Přidat event listener pro textarea s CNC kódem
        document.getElementById('cncCode').addEventListener('input', function() {
            debug('CNC kód změněn');
        });

        document.getElementById('parseCodeButton').addEventListener('click', parseCncCode);

        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const value = parseFloat(e.target.value);
                if (!isNaN(value)) {
                    e.target.value = roundToThree(value);
                }
            });
        });

        document.getElementById('speedModeButton').addEventListener('click', function() {
            const button = this;
            const isG96 = !button.classList.contains('g97');

            if (isG96) {
                button.classList.add('g97');
                button.textContent = 'G97 (konstantní otáčky)';
                document.getElementById('g96conditions').style.display = 'none';
                document.getElementById('g97conditions').style.display = 'block';
            } else {
                button.classList.remove('g97');
                button.textContent = 'G96 (konstantní řezná rychlost)';
                document.getElementById('g96conditions').style.display = 'block';
                document.getElementById('g97conditions').style.display = 'none';
            }

            calculateAll();
        });

        document.getElementById('radiusType').addEventListener('change', function() {
            const type = this.value;
            const ctButton = document.getElementById('ctButton');
            const ikButton = document.getElementById('ikButton');
            const arButton = document.getElementById('arButton');
            const cipButton = document.getElementById('cipButton');
            const calcCenterButton = document.getElementById('calcCenterButton');
            const prevPointSection = document.getElementById('prevPointSection');
            const calculatedRadius = document.getElementById('calculatedRadius');

            prevPointSection.style.display = type === 'CT' ? 'block' : 'none';
            // Změna: Zobrazíme radius i pro IK režim
            calculatedRadius.style.display = (type === 'CT' || type === 'IK') ? 'block' : 'none';

            // Aktualizovat text všech tlačítek
            ctButton.textContent = type === 'CT' ? 'Vypočítat CT' : 'CT';
            ikButton.textContent = type === 'IK' ? 'Vypočítat IK' : 'IK';
            arButton.textContent = type === 'AR' ? 'Vypočítat AR' : 'AR';
            cipButton.textContent = type === 'CIP' ? 'Vypočítat CIP' : 'CIP';
            calcCenterButton.textContent = type === 'CR' ? 'Vypočítat CR' : 'CR';

            // Předvyplnit hodnoty pro IK
            if (type === 'IK') {
                const startX = parseFloat(document.getElementById('startX').value);
                const startZ = parseFloat(document.getElementById('startZ').value);
                const centerX = parseFloat(document.getElementById('centerX').value);
                const centerZ = parseFloat(document.getElementById('centerZ').value);

                // Výpočet relativních souřadnic středu vůči počátečnímu bodu
                const i = centerX - startX;
                const k = centerZ - startZ;

                // Vypočet radiusu - správná vzdálenost od středu k začátku oblouku
                const radius = Math.sqrt(i*i + k*k);  // Přímá vzdálenost od středu k začátku

                // Nastavení vypočtených hodnot
                document.getElementById('centerDX').value = i.toFixed(3);
                document.getElementById('centerDZ').value = k.toFixed(3);
                document.getElementById('calculatedRadius').querySelector('.calculated-value').textContent = radius.toFixed(3);
                document.getElementById('radius').value = radius.toFixed(3);

                debug(`Předvyplnění IK parametrů:`);
                debug(`I = ${i.toFixed(3)} (${centerX} - ${startX})`);
                debug(`K = ${k.toFixed(3)} (${centerZ} - ${startZ})`);
                debug(`Vypočtený radius = ${radius.toFixed(3)} (odmocnina z I² + K²)`);
            }

            document.querySelectorAll('[id^="radiusInput"]').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById(`radiusInput${type}`).style.display = 'block';
        });

        document.getElementById('calcCenterButton').addEventListener('click', function() {
            const radiusType = document.getElementById('radiusType');
            if (radiusType.value === 'CR') {
                calculateCenter(true);
            } else {
                radiusType.value = 'CR';
                radiusType.dispatchEvent(new Event('change'));
            }
        });

        document.getElementById('ctButton').addEventListener('click', function() {
            const radiusType = document.getElementById('radiusType');
            if (radiusType.value === 'CT') {
                const prevX = parseFloat(document.getElementById('prevX').value);
                const prevZ = parseFloat(document.getElementById('prevZ').value);
                const startX = parseFloat(document.getElementById('startX').value);
                const startZ = parseFloat(document.getElementById('startZ').value);
                const endX = parseFloat(document.getElementById('endX').value);
                const endZ = parseFloat(document.getElementById('endZ').value);

                try {
                    const result = GeometryCalculator.calculateCenterFromTangent(prevX, prevZ, startX, startZ, endX, endZ);

                    // Určení správného směru
                    const direction = checkArcDirection(
                        prevX, prevZ, startX, startZ, endX, endZ,
                        result.x, result.z
                    );

                    // Nastavit správný směr
                    document.getElementById('direction').value = direction;

                    document.getElementById('centerX').value = result.x.toFixed(3);
                    document.getElementById('centerZ').value = result.z.toFixed(3);
                    document.getElementById('radius').value = result.radius.toFixed(3);
                    document.getElementById('calculatedRadius').querySelector('.calculated-value').textContent =
                        result.radius.toFixed(3);

                    calculateAll();
                } catch (error) {
                    document.getElementById('error-message').textContent = error.message;
                    debug(`Chyba: ${error.message}`);
                }
            } else {
                radiusType.value = 'CT';
                radiusType.dispatchEvent(new Event('change'));
            }
        });

        document.getElementById('ikButton').addEventListener('click', function() {
            const radiusType = document.getElementById('radiusType');
            if (radiusType.value === 'IK') {
                calculateCenter(true);
            } else {
                radiusType.value = 'IK';
                radiusType.dispatchEvent(new Event('change'));
            }
        });

        document.getElementById('arButton').addEventListener('click', function() {
            const radiusType = document.getElementById('radiusType');
            if (radiusType.value === 'AR') {
                calculateCenter(true);
            } else {
                radiusType.value = 'AR';
                radiusType.dispatchEvent(new Event('change'));
            }
        });

        document.getElementById('cipButton').addEventListener('click', function() {
            const radiusType = document.getElementById('radiusType');
            if (radiusType.value === 'CIP') {
                calculateCenter(true);
            } else {
                radiusType.value = 'CIP';
                radiusType.dispatchEvent(new Event('change'));
            }
        });

        (function setupDiagramControls() {
            const svg = document.getElementById('diagram');
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            const zoomReset = document.getElementById('zoomReset');
            let viewBox = { x: 0, y: 0, width: 200, height: 200 };
            let isPanning = false;
            let startPoint = { x: 0, y: 0 };
            let pointStart = { x: 0, y: 0 };
            const ZOOM_STEP = 0.1;
            const MIN_ZOOM = 0.5;
            const MAX_ZOOM = 5;

            function setViewBox() {
                svg.setAttribute('viewBox',
                    `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
            }

            function zoom(factor, centerX, centerY) {
                const oldWidth = viewBox.width;
                const oldHeight = viewBox.height;
                const newWidth = viewBox.width * factor;
                const newHeight = viewBox.height * factor;

                if (newWidth / 200 < MIN_ZOOM || newWidth / 200 > MAX_ZOOM) return;

                viewBox.x = centerX - (centerX - viewBox.x) * factor;
                viewBox.y = centerY - (centerY - viewBox.y) * factor;
                viewBox.width = newWidth;
                viewBox.height = newHeight;

                setViewBox();
            }

            zoomIn.addEventListener('click', () => zoom(0.9, viewBox.x + viewBox.width/2, viewBox.y + viewBox.height/2));
            zoomOut.addEventListener('click', () => zoom(1.1, viewBox.x + viewBox.width/2, viewBox.y + viewBox.height/2));
            zoomReset.addEventListener('click', () => {
                const svg = document.getElementById('diagram');
                const originalViewBox = svg.dataset.originalViewBox;
                if (originalViewBox) {
                    const [x, y, width, height] = originalViewBox.split(' ').map(Number);
                    viewBox = { x, y, width, height };
                    setViewBox();
                }
            });

            svg.addEventListener('mousedown', (e) => {
                isPanning = true;
                startPoint = { x: e.clientX, y: e.clientY };
                pointStart = { x: viewBox.x, y: viewBox.y };
                svg.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isPanning) return;

                const rect = svg.getBoundingClientRect();
                const dx = (e.clientX - startPoint.x) * (viewBox.width / rect.width);
                const dy = (e.clientY - startPoint.y) * (viewBox.height / rect.height);

                viewBox.x = pointStart.x - dx;
                viewBox.y = pointStart.y - dy;
                setViewBox();
            });

            window.addEventListener('mouseup', () => {
                isPanning = false;
                svg.style.cursor = 'default';
            });

            let lastDistance = 0;
            let touchStartViewBox = null;

            svg.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    lastDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    touchStartViewBox = {...viewBox};
                } else if (e.touches.length === 1) {
                    isPanning = true;
                    startPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    pointStart = { x: viewBox.x, y: viewBox.y };
                }
            });

            svg.addEventListener('touchmove', (e) => {
                e.preventDefault();

                if (e.touches.length === 2) {
                    const distance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const center = {
                        x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
                        y: (e.touches[0].clientY + e.touches[1].clientY) / 2
                    };
                    const rect = svg.getBoundingClientRect();
                    const svgPoint = {
                        x: viewBox.x + (center.x - rect.left) / rect.width * viewBox.width,
                        y: viewBox.y + (center.y - rect.top) / rect.height * viewBox.height
                    };

                    const factor = distance / lastDistance;
                    zoom(1/factor, svgPoint.x, svgPoint.y);
                    lastDistance = distance;
                } else if (e.touches.length === 1 && isPanning) {
                    const rect = svg.getBoundingClientRect();
                    const dx = (e.touches[0].clientX - startPoint.x) * (viewBox.width / rect.width);
                    const dy = (e.touches[0].clientY - startPoint.y) * (viewBox.height / rect.height);

                    viewBox.x = pointStart.x - dx;
                    viewBox.y = pointStart.y - dy;
                    setViewBox();
                }
            });

            svg.addEventListener('touchend', () => {
                isPanning = false;
                lastDistance = 0;
                touchStartViewBox = null;
            });
        })();

        function validateArc(params) {
            const radiusType = document.getElementById('radiusType').value;

            // Přidáme vyjímku i pro IK mód
            if (radiusType === 'CT' || radiusType === 'IK') {
                return true;
            }

            const startDist = Math.hypot(
                params.startZ - params.centerZ,
                params.startX - params.centerX
            );
            const endDist = Math.hypot(
                params.endZ - params.centerZ,
                params.endX - params.centerX
            );

            // Zvětšíme toleranci pro větší radiusy
            const tolerance = Math.max(0.1, params.radius * 0.01);

            debug(`\nValidace oblouku:`);
            debug(`Start bod: X=${params.startX}, Z=${params.startZ}`);
            debug(`End bod: X=${params.endX}, Z=${params.endZ}`);
            debug(`Střed: X=${params.centerX}, Z=${params.centerZ}`);
            debug(`Vzdálenosti od středu: Start=${startDist.toFixed(3)}, End=${endDist.toFixed(3)}, Radius=${params.radius}`);
            debug(`Použitá tolerance: ${tolerance.toFixed(3)}`);

            const startDiff = Math.abs(startDist - params.radius);
            const endDiff = Math.abs(endDist - params.radius);

            debug(`Odchylka na začátku: ${startDiff.toFixed(3)}`);
            debug(`Odchylka na konci: ${endDiff.toFixed(3)}`);

            if (startDiff > tolerance || endDiff > tolerance) {
                debug('Validace oblouku: NEPLATNÝ - body neleží na kružnici s daným radiusem');
                return false;
            }

            debug('Validace oblouku: OK');
            return true;
        }

        document.getElementById('inputMethod').addEventListener('change', function(e) {
            const cncSection = document.getElementById('cncInputSection');
            const manualSection = document.getElementById('manualInputSection');

            if (e.target.value === 'cnc') {
                cncSection.style.display = 'block';
                manualSection.style.display = 'none';
            } else {
                cncSection.style.display = 'none';
                manualSection.style.display = 'block';

                // Načíst poslední hodnoty z localStorage
                const lastValues = localStorage.getItem('lastParsedValues');
                const lastMethod = localStorage.getItem('lastInputMethod');

                if (lastValues && lastMethod) {
                    debug('Načítám uložené hodnoty:');
                    const values = JSON.parse(lastValues);
                    debug(JSON.stringify(values, null, 2));

                    // Použít updateValues místo setValuesAndCalculate
                    updateValues({
                        ...values,
                        type: lastMethod
                    });
                }
            }
        });

        function validateInputs(params) {
            // Základní kontroly hodnot
            if (params.radius <= 0) {
                debug('Chyba: Radius musí být větší než 0');
                return false;
            }

            // Kontrola řezných podmínek
            if (params.feed <= 0) {
                debug('Chyba: Posuv musí být větší než 0');
                return false;
            }

            if (params.cuttingSpeed <= 0) {
                debug('Chyba: Řezná rychlost musí být větší než 0');
                return false;
            }

            // Kontrola souřadnic
            const coordinates = [
                params.startX, params.startZ,
                params.endX, params.endZ,
                params.centerX, params.centerZ
            ];

            if (coordinates.some(coord => !isFinite(coord))) {
                debug('Chyba: Neplatné souřadnice');
                return false;
            }

            // Kontrola vzdálenosti bodů
            const startEndDist = Math.hypot(
                params.endX - params.startX,
                params.endZ - params.startZ
            );

            if (startEndDist < 0.001) {
                debug('Chyba: Začátek a konec radiusu nemohou být stejné');
                return false;
            }

            debug('Validace vstupů: OK');
            return true;
        }

        // Také upravíme calculateCenter, aby vracel správné hodnoty pro CT
        function calculateCenterFromTangent(prevX, prevZ, startX, startZ, endX, endZ) {
            // 1. Výpočet směrového vektoru první přímky
            const v1x = startX - prevX;
            const v1z = startZ - prevZ;
            const len1 = Math.sqrt(v1x*v1x + v1z*v1z);

            if (len1 === 0) {
                throw new Error("Počáteční bod a začátek radiusu nemohou být stejné");
            }

            // 2. Normalizace vektoru
            const n1x = v1x / len1;
            const n1z = v1z / len1;

            debug(`Směrový vektor první přímky: (${n1x.toFixed(4)}, ${n1z.toFixed(4)})`);

            // 3. Výpočet kolmice (normálového vektoru) - pro soustruh otáčíme o 90° doprava
            const p1x = -n1z;  // Kolmice pro soustruh
            const p1z = n1x;   // Kolmice pro soustruh

            debug(`Kolmý vektor k první přímce: (${p1x.toFixed(4)}, ${p1z.toFixed(4)})`);

            // 4. Výpočet vektoru ke koncovému bodu
            const v2x = endX - startX;
            const v2z = endZ - startZ;
            const dist = Math.sqrt(v2x*v2x + v2z*v2z);

            debug(`Vektor od začátku ke konci radiusu: (${v2x.toFixed(4)}, ${v2z.toFixed(4)})`);
            debug(`Vzdálenost mezi začátkem a koncem radiusu: ${dist.toFixed(4)}`);

            // 5. Výpočet parametru t pro střed oblouku
            const numerator = (v2x*v2x + v2z*v2z);
            const denominator = 2 * (v2x * p1x + v2z * p1z);

            if (Math.abs(denominator) < 0.0001) {
                throw new Error("Nelze najít střed - zkuste jiné body nebo směr");
            }

            const t = numerator / denominator;

            // Přidat kontrolu velikosti radiusu vzhledem k vzdálenosti bodů
            if (Math.abs(t) < dist * 0.1) {
                throw new Error("Vypočtený radius je příliš malý vzhledem ke vzdálenosti bodů");
            }
            if (Math.abs(t) > dist * 10) {
                throw new Error("Vypočtený radius je příliš velký vzhledem ke vzdálenosti bodů");
            }

            debug(`Parametr t pro vzdálenost středu po kolmici: ${t.toFixed(4)}`);

            // 6. Výpočet středu a radiusu
            const centerX = startX + t * p1x;
            const centerZ = startZ + t * p1z;
            const radius = Math.abs(t); // Pro CT je radius roven absolutní hodnotě parametru t

            debug(`Vypočtený střed: X=${centerX.toFixed(4)}, Z=${centerZ.toFixed(4)}`);
            debug(`Vypočtený poloměr: ${radius.toFixed(4)}`);

            return { x: centerX, z: centerZ, radius };
        }

        function checkArcDirection(prevX, prevZ, startX, startZ, endX, endZ, centerX, centerZ) {
            // Výpočet vektorů
            const v1x = startX - prevX;
            const v1z = startZ - prevZ;

            // Vektor od středu k počátku oblouku
            const sc1x = startX - centerX;
            const sc1z = startZ - centerZ;

            // Vektor od středu ke konci oblouku
            const sc2x = endX - centerX;
            const sc2z = endZ - centerZ;

            // Vektorový součin pro určení orientace
            const cross1 = v1x * sc1z - v1z * sc1x;
            const cross2 = sc1x * sc2z - sc1z * sc2x;

            debug(`Kontrola směru oblouku:`);
            debug(`Cross1: ${cross1.toFixed(4)}`);
            debug(`Cross2: ${cross2.toFixed(4)}`);

            // Pro soustruh je orientace opačná než v běžném kartézském systému
            return (cross1 * cross2 >= 0) ? 'G3' : 'G2';
        }

        function calculateCenterFromRadius(startX, startZ, endX, endZ, radius, direction) {
            debug('\nVýpočet středu pomocí radiusu:');
            debug(`Start bod: X=${startX}, Z=${startZ}`);
            debug(`Konec bod: X=${endX}, Z=${endZ}`);
            debug(`Radius: ${radius}`);
            debug(`Směr: ${direction}`);

            // Výpočet středové úsečky
            const midX = (startX + endX) / 2;
            const midZ = (startZ + endZ) / 2;

            // Vektor od počátku ke konci
            const vx = endX - startX;
            const vz = endZ - startZ;

            // Délka tětivy (vzdálenost mezi body)
            const chord = Math.sqrt(vx * vx + vz * vz);

            if (chord === 0) {
                throw new Error("Počáteční a koncový bod nemohou být stejné");
            }

            if (chord > 2 * radius) {
                throw new Error(`Radius ${radius} je příliš malý pro vzdálenost bodů ${chord.toFixed(3)}`);
            }

            // Výška od středu tětivy ke středu kružnice (Pythagorova věta)
            const h = Math.sqrt(radius * radius - (chord * chord) / 4);

            // Normalizovaný kolmý vektor k tětivě
            const nx = -vz / chord;  // Pro soustruh otáčíme o 90° doprava
            const nz = vx / chord;   // Pro soustruh otáčíme o 90° doprava

            debug(`Normálový vektor: (${nx.toFixed(4)}, ${nz.toFixed(4)})`);

            // Znaménko výšky podle směru (G2/G3)
            const sign = direction === 'G2' ? -1 : 1;

            // Výpočet středu
            const centerX = midX + sign * h * nx;
            const centerZ = midZ + sign * h * nz;

            debug(`Vypočtený střed: X=${centerX.toFixed(4)}, Z=${centerZ.toFixed(4)}`);

            return {
                x: centerX,
                z: centerZ
            };
        }
    </script>
</body>
</html>